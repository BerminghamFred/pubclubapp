generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model City {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  boroughs  Borough[]
  pubs      Pub[]

  @@map("cities")
}

model Borough {
  id     Int    @id @default(autoincrement())
  name   String
  cityId Int
  city   City   @relation(fields: [cityId], references: [id])
  pubs   Pub[]

  @@unique([cityId, name])
  @@map("boroughs")
}

model Pub {
  id              String         @id @default(cuid())
  name            String
  slug            String         @unique
  placeId         String?        @unique // Google Place ID (ChIJ...) or temp ID
  address         String?
  postcode        String?
  lat             Float?
  lng             Float?
  cityId          Int?
  boroughId       Int?
  priceRange      String?
  description     String?
  phone           String?
  website         String?
  rating          Float?
  reviewCount     Int?
  openingHours    String?
  photoUrl        String?
  photoName       String? // Google Places API photo name
  managerEmail    String? // Legacy: direct manager email on pub
  managerPassword String? // Legacy: hashed password
  type            String? // Traditional, Modern, Gastro Pub, Food Pub
  features        String[]       @default([]) // Legacy features array
  lastUpdated     DateTime?
  updatedBy       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  userReviewCount Int            @default(0)
  userRatingAvg   Float?
  wishlistCount   Int            @default(0)
  checkinCount    Int            @default(0)
  checkins        Checkin[]
  logins          ManagerLogin[]
  amenities       PubAmenity[]
  managers        PubManager[]
  photos          PubPhoto[]
  borough         Borough?       @relation(fields: [boroughId], references: [id])
  city            City?          @relation(fields: [cityId], references: [id])
  reviews         Review[]
  wishlist        Wishlist[]

  @@map("pubs")
}

model Amenity {
  id    Int          @id @default(autoincrement())
  key   String       @unique
  label String
  pubs  PubAmenity[]

  @@map("amenities")
}

model PubAmenity {
  pubId     String
  amenityId Int
  value     Boolean @default(true)
  amenity   Amenity @relation(fields: [amenityId], references: [id], onDelete: Cascade)
  pub       Pub     @relation(fields: [pubId], references: [id], onDelete: Cascade)

  @@id([pubId, amenityId])
  @@map("pub_amenities")
}

model PubPhoto {
  id         String   @id @default(cuid())
  pubId      String
  url        String
  isCover    Boolean  @default(false)
  uploadedBy String?
  createdAt  DateTime @default(now())
  pub        Pub      @relation(fields: [pubId], references: [id], onDelete: Cascade)

  @@map("pub_photos")
}

model Manager {
  id        String         @id @default(cuid())
  email     String         @unique
  name      String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  logins    ManagerLogin[]
  pubs      PubManager[]

  @@map("managers")
}

model PubManager {
  pubId     String
  managerId String
  role      String  @default("owner")
  manager   Manager @relation(fields: [managerId], references: [id], onDelete: Cascade)
  pub       Pub     @relation(fields: [pubId], references: [id], onDelete: Cascade)

  @@id([pubId, managerId])
  @@map("pub_managers")
}

model ManagerLogin {
  id         String   @id @default(cuid())
  managerId  String?
  pubId      String?
  loggedInAt DateTime @default(now())
  manager    Manager? @relation(fields: [managerId], references: [id])
  pub        Pub?     @relation(fields: [pubId], references: [id])

  @@map("manager_logins")
}

model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("content_admin")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_users")
}

model AdminAudit {
  id        String   @id @default(cuid())
  actorId   String?
  action    String
  entity    String
  entityId  String
  diff      Json?
  createdAt DateTime @default(now())

  @@map("admin_audit")
}

model EventPageView {
  id        String   @id @default(cuid())
  ts        DateTime @default(now())
  userId    String?
  sessionId String
  pubId     String?
  areaSlug  String?
  ref       String?
  utm       Json?
  device    String?

  @@unique([sessionId, pubId])
  @@map("events_page_view")
}

model EventSearch {
  id           String   @id @default(cuid())
  ts           DateTime @default(now())
  userId       String?
  sessionId    String
  query        String
  cityId       Int?
  boroughId    Int?
  resultsCount Int?

  @@map("events_search")
}

model EventFilterUsage {
  id        String   @id @default(cuid())
  ts        DateTime @default(now())
  sessionId String
  filterKey String
  cityId    Int?
  boroughId Int?

  @@unique([sessionId, filterKey])
  @@map("events_filter_usage")
}

model EventCtaClick {
  id        String   @id @default(cuid())
  ts        DateTime @default(now())
  sessionId String
  pubId     String
  type      String

  @@map("events_cta_click")
}

model PubViewsDaily {
  id    String   @id @default(cuid())
  pubId String
  date  DateTime
  views Int      @default(0)

  @@unique([pubId, date])
  @@map("pub_views_daily")
}

model FiltersDaily {
  id        String   @id @default(cuid())
  filterKey String
  cityId    Int?
  boroughId Int?
  date      DateTime
  uses      Int      @default(0)

  @@unique([filterKey, cityId, boroughId, date])
  @@map("filters_daily")
}

model SearchesDaily {
  id        String   @id @default(cuid())
  cityId    Int?
  boroughId Int?
  date      DateTime
  count     Int      @default(0)

  @@unique([cityId, boroughId, date])
  @@map("searches_daily")
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String?
  name      String?
  image     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  checkins  Checkin[]
  reviews   Review[]
  wishlist  Wishlist[]

  @@map("users")
}

model Review {
  id            String   @id @default(cuid())
  userId        String
  pubId         String
  rating        Int
  title         String?
  body          String
  photos        String?
  isEdited      Boolean  @default(false)
  isVisible     Boolean  @default(true)
  reportedCount Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  pub           Pub      @relation(fields: [pubId], references: [id])
  user          User     @relation(fields: [userId], references: [id])

  @@unique([userId, pubId])
  @@index([pubId])
  @@index([userId])
  @@map("reviews")
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  pubId     String
  createdAt DateTime @default(now())
  pub       Pub      @relation(fields: [pubId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, pubId])
  @@index([userId])
  @@index([pubId])
  @@map("wishlist")
}

model Checkin {
  id        String   @id @default(cuid())
  userId    String
  pubId     String
  note      String?
  visitedAt DateTime @default(now())
  pub       Pub      @relation(fields: [pubId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, pubId])
  @@index([userId])
  @@index([pubId])
  @@map("checkins")
}

model HomepageSlot {
  id           String                    @id @default(cuid())
  title        String
  subtitle     String
  href         String
  icon         String
  areaSlug     String
  amenitySlug  String?
  pubCount     Int
  score        Float
  isSeasonal   Boolean                   @default(false)
  isActive     Boolean                   @default(true)
  position     Int?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  views        Int                       @default(0)
  clicks       Int                       @default(0)
  lastViewed   DateTime?
  interactions HomepageSlotInteraction[]

  @@unique([areaSlug, amenitySlug])
  @@index([score])
  @@index([isActive, position])
  @@map("homepage_slots")
}

model HomepageSlotInteraction {
  id        String       @id @default(cuid())
  slotId    String
  sessionId String
  type      String
  createdAt DateTime     @default(now())
  slot      HomepageSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)

  @@index([slotId])
  @@index([sessionId])
  @@map("homepage_slot_interactions")
}

model AreaFeaturedPub {
  id        String   @id @default(cuid())
  areaName  String   @unique
  pubId     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("area_featured_pubs")
}

model PubRequest {
  id           String   @id @default(cuid())
  pubName      String
  postcode     String
  managerName  String
  contactEmail String
  contactPhone String
  status       String   @default("pending") // pending, reviewed, approved, rejected
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("pub_requests")
}

model BlogSubscription {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("blog_subscriptions")
}
